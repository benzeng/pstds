**ä¸ªäººä¸“ç”¨è‚¡ç¥¨äº¤æ˜“å†³ç­–ç³»ç»Ÿ**

*PSTDS --- Personal Stock Trading Decision System*

**æµ‹è¯•è§„èŒƒæ–‡æ¡£ï¼ˆTSDï¼‰v1.0**

Test Specification Document \| 2026å¹´2æœˆ \| ç‰ˆæœ¬ v1.0

**1. æµ‹è¯•ç­–ç•¥æ€»è§ˆ**

PSTDS
çš„æµ‹è¯•ç­–ç•¥ä»¥ã€Œå¯ä¿¡åº¦éªŒè¯ã€ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œé‡ç‚¹ä¿éšœæ—¶é—´éš”ç¦»å±‚ï¼ˆTemporalGuardï¼‰çš„æ­£ç¡®æ€§ã€‚å…¶æ¬¡æ˜¯æ•°æ®é€‚é…å±‚çš„å¥‘çº¦æµ‹è¯•å’Œæ ¸å¿ƒä¸šåŠ¡æµç¨‹çš„é›†æˆæµ‹è¯•ã€‚æ‰€æœ‰æµ‹è¯•åœ¨
CI/CD æµæ°´çº¿ä¸­è‡ªåŠ¨æ‰§è¡Œï¼Œå‘ç°å¤±è´¥æ—¶é˜»æ­¢ä»£ç åˆå¹¶ã€‚

  ----------------------------------------------------------------------------
  **æµ‹è¯•çº§åˆ«**     **è¦†ç›–ç›®æ ‡**               **ä¼˜å…ˆçº§**   **è¦†ç›–ç‡è¦æ±‚**
  ---------------- -------------------------- ------------ -------------------
  L1 å•å…ƒæµ‹è¯•      TemporalGuardã€Pydantic    ğŸ”´ æœ€é«˜      \> 95%ï¼ˆtemporal/
                   æ¨¡å‹ã€è·¯ç”±è§„åˆ™ã€ç¼“å­˜é€»è¾‘                æ¨¡å—ï¼‰

  L2               å„é€‚é…å™¨å¥‘çº¦æµ‹è¯•ï¼ˆä½¿ç”¨     ğŸ”´ é«˜        \> 80%
  æ•°æ®é€‚é…å™¨æµ‹è¯•   Mock å’Œæœ¬åœ° Fixtureï¼‰                   

  L3 é›†æˆæµ‹è¯•      å®Œæ•´åˆ†ææµç¨‹ç«¯åˆ°ç«¯ï¼ˆä½¿ç”¨   ğŸŸ  ä¸­é«˜      å…³é”®è·¯å¾„ 100%
                   Fixture æ•°æ®ï¼‰                          

  L4 å›å½’æµ‹è¯•      å‰è§†åå·®å›å½’ï¼ˆAAPL         ğŸ”´ æœ€é«˜      å¿…é¡» 100% é€šè¿‡
                   2024-01â†’03ï¼‰ã€å†³ç­–ä¸€è‡´æ€§                

  L5 æˆæœ¬æµ‹è¯•      Token é¢„ç®—ç®¡æ§ã€è¶…é™é™çº§   ğŸŸ¡ ä¸­        æ ¸å¿ƒè·¯å¾„è¦†ç›–
  ----------------------------------------------------------------------------

**2. å•å…ƒæµ‹è¯•è§„èŒƒï¼ˆL1ï¼‰**

**2.1 TemporalGuard æµ‹è¯•å¥—ä»¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**

  -------------------------------------------------------------------
  *ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹å¿…é¡»åœ¨ Phase 1
  å¼€å‘å®Œæˆæ—¶å…¨éƒ¨é€šè¿‡ï¼Œè¿™æ˜¯ç³»ç»Ÿå¯åŠ¨ç”Ÿäº§ä½¿ç”¨çš„æœ€ä½é—¨æ§›ã€‚è¦†ç›–ç‡è¦æ±‚
  100%ï¼Œä»»ä½•ä¸€ä¸ªç”¨ä¾‹å¤±è´¥å‡è§†ä¸ºé˜»å¡æ€§ç¼ºé™·ã€‚*

  -------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **æµ‹è¯•åç§°**                          **æµ‹è¯•å†…å®¹**                    **é¢„æœŸç»“æœ**
  ID**                                                                               
  ------------ ------------------------------------- ------------------------------- --------------------------------
  TG-001       test_valid_past_timestamp             data_timestamp =                é€šè¿‡æ ¡éªŒï¼Œæ— å¼‚å¸¸
                                                     analysis_date - 1å¤©             

  TG-002       test_valid_equal_timestamp            data_timestamp = analysis_date  é€šè¿‡æ ¡éªŒï¼Œæ— å¼‚å¸¸

  TG-003       test_future_timestamp_raises          data_timestamp =                æŠ›å‡º TemporalViolationError
                                                     analysis_date + 1å¤©             

  TG-004       test_audit_log_on_violation           è§¦å‘ TG-003 åæ£€æŸ¥å®¡è®¡æ—¥å¿—      æ—¥å¿—ä¸­è®°å½• is_compliant=False
                                                                                     åŠè¿è§„è¯¦æƒ…

  TG-005       test_news_filter_removes_future       æ–°é—»åˆ—è¡¨å« 3 æ¡æœªæ¥æ–°é—»ï¼Œ5      è¿”å› 5 æ¡ï¼Œè¿‡æ»¤æ•°é‡è®°å½•åˆ°æ—¥å¿—
                                                     æ¡åˆè§„                          

  TG-006       test_news_filter_all_compliant        å…¨éƒ¨æ–°é—»å‡åˆè§„                  è¿”å›åŸåˆ—è¡¨ï¼Œæ—¥å¿—è®°å½•
                                                                                     filtered_count=0

  TG-007       test_news_filter_all_future           å…¨éƒ¨æ–°é—»å‡ä¸ºæœªæ¥                è¿”å›ç©ºåˆ—è¡¨

  TG-008       test_backtest_blocks_realtime         BACKTEST æ¨¡å¼è°ƒç”¨               æŠ›å‡º RealtimeAPIBlockedError
                                                     assert_backtest_safe            

  TG-009       test_live_allows_realtime             LIVE æ¨¡å¼è°ƒç”¨                   é€šè¿‡ï¼Œæ— å¼‚å¸¸
                                                     assert_backtest_safe            

  TG-010       test_prompt_injection_contains_date   è°ƒç”¨ inject_temporal_prompt     è¿”å›å­—ç¬¦ä¸²é¦–éƒ¨åŒ…å« analysis_date
                                                                                     å­—ç¬¦ä¸²

  TG-011       test_context_immutable                å°è¯•ä¿®æ”¹                        æŠ›å‡º
                                                     TemporalContext.analysis_date   FrozenInstanceErrorï¼ˆdataclass
                                                                                     frozen=Trueï¼‰

  TG-012       test_aapl_lookahead_regression        ä½¿ç”¨ 2024-01-02 ä¸º              ä¸è¿”å› 2024-01-02 ä¹‹åçš„ä»»ä½•æ•°æ®
                                                     analysis_date è¯·æ±‚å½“æ—¥æ•°æ®      
  -------------------------------------------------------------------------------------------------------------------

**2.2 æ•°æ®æ¨¡å‹ï¼ˆPydanticï¼‰æµ‹è¯•å¥—ä»¶**

  --------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **æµ‹è¯•å†…å®¹**                    **é¢„æœŸç»“æœ**
  ID**                                         
  ------------ ------------------------------- -----------------------------------
  PM-001       TradeDecision: action=\'BUY\',  åˆ›å»ºæˆåŠŸ
               confidence=0.72,                
               æ‰€æœ‰å¿…å¡«å­—æ®µå®Œæ•´                

  PM-002       TradeDecision:                  æŠ›å‡º ValidationError
               confidence=1.5ï¼ˆè¶…å‡ºèŒƒå›´ï¼‰      

  PM-003       TradeDecision:                  æŠ›å‡º ValidationError
               insufficient_data=True,         
               action=\'BUY\'ï¼ˆçŸ›ç›¾ï¼‰          

  PM-004       TradeDecision:                  æŠ›å‡º ValidationError
               target_price_high \<            
               target_price_low                

  PM-005       TradeDecision:                  æŠ›å‡º
               risk_factors=\[\]ï¼ˆç©ºåˆ—è¡¨ï¼‰     ValidationErrorï¼ˆmin_length=1ï¼‰

  PM-006       TradeDecision: primary_reason   æŠ›å‡º
               è¶…è¿‡ 100 å­—                     ValidationErrorï¼ˆmax_length=100ï¼‰

  PM-007       OHLCVRecord: high \<            æŠ›å‡º ValidationError
               lowï¼ˆå¼‚å¸¸æ•°æ®ï¼‰                 

  PM-008       NewsItem: relevance_score=-0.1  æŠ›å‡º ValidationError
  --------------------------------------------------------------------------------

**2.3 å¸‚åœºè·¯ç”±å™¨æµ‹è¯•**

  -----------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **è¾“å…¥ Symbol**   **é¢„æœŸå¸‚åœºç±»å‹**   **é¢„æœŸä¸»é€‚é…å™¨**
  ID**                                              
  ------------ ----------------- ------------------ ---------------------------------
  RT-001       \'600519\'        CN_A               AKShareAdapter

  RT-002       \'000001\'        CN_A               AKShareAdapter

  RT-003       \'300750\'        CN_A               AKShareAdapter

  RT-004       \'0700.HK\'       HK                 AKShareAdapterï¼ˆæ¸¯è‚¡æ¥å£ï¼‰

  RT-005       \'AAPL\'          US                 YFinanceAdapter

  RT-006       \'NVDA\'          US                 YFinanceAdapter

  RT-007       \'SPY\'           US                 YFinanceAdapter

  RT-008       \'INVALID@#\$\'   å¼‚å¸¸               æŠ›å‡º
                                                    MarketNotSupportedErrorï¼ˆE009ï¼‰
  -----------------------------------------------------------------------------------

**3. æ•°æ®é€‚é…å™¨å¥‘çº¦æµ‹è¯•ï¼ˆL2ï¼‰**

  -------------------------------------------------------------------
  *æ‰€æœ‰é€‚é…å™¨æµ‹è¯•ä½¿ç”¨é¢„ç½®çš„ Fixture æ•°æ®ï¼ˆæœ¬åœ° JSON/CSV
  æ–‡ä»¶ï¼‰ï¼Œä¸è¿›è¡ŒçœŸå®ç½‘ç»œè¯·æ±‚ã€‚è¿™ç¡®ä¿æµ‹è¯•åœ¨ç¦»çº¿ç¯å¢ƒå’Œ CI/CD
  ä¸­å‡å¯è¿è¡Œã€‚Fixture æ•°æ®ä½äº tests/fixtures/ ç›®å½•ã€‚*

  -------------------------------------------------------------------

**3.1 YFinanceAdapter æµ‹è¯•**

  ------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **æµ‹è¯•å†…å®¹**                **ä½¿ç”¨ Fixture**
  ID**                                     
  ------------ --------------------------- -------------------------------------
  YF-001       get_ohlcv                   fixtures/aapl_ohlcv_2024.csv
               è¿”å›æ­£ç¡®åˆ—åå’Œæ•°æ®ç±»å‹      

  YF-002       get_ohlcv                   fixtures/aapl_ohlcv_2024.csv
               æ—¶é—´éš”ç¦»ï¼šend_date          
               åçš„æ•°æ®è¢«è¿‡æ»¤              

  YF-003       get_fundamentals            fixtures/aapl_fundamentals.json
               è¿”å›æ‰€æœ‰å¿…éœ€å­—æ®µ            

  YF-004       get_news è¿‡æ»¤æœªæ¥æ–°é—»       fixtures/aapl_news_mixed_dates.json

  YF-005       get_ohlcv ç©ºç»“æœæ—¶è¿”å›ç©º    fixtures/empty_response.json
               DataFrame è€Œéå¼‚å¸¸          
  ------------------------------------------------------------------------------

**3.2 AKShareAdapter æµ‹è¯•**

  -----------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **æµ‹è¯•å†…å®¹**                     **ä½¿ç”¨ Fixture**
  ID**                                          
  ------------ -------------------------------- -------------------------------------
  AK-001       Aè‚¡ä»£ç  600519                   fixtures/kweichow_ohlcv.csv
               è¡Œæƒ…è·å–ï¼Œåˆ—åæ ‡å‡†åŒ–             

  AK-002       Aè‚¡è´¢åŠ¡æŠ¥è¡¨å­—æ®µä¸­æ–‡â†’è‹±æ–‡æ˜ å°„     fixtures/kweichow_fundamentals.json

  AK-003       ä¸œæ–¹è´¢å¯Œè‚¡å§æƒ…ç»ªæ•°æ®æ—¶é—´æˆ³è¿‡æ»¤   fixtures/df_sentiment_mixed.json

  AK-004       æ¸¯è‚¡ä»£ç  0700.HK è¡Œæƒ…è·å–        fixtures/tencent_hk_ohlcv.csv

  AK-005       æ•°æ®æºä¸å¯ç”¨æ—¶è¿”å›ç©ºè€Œéå¼‚å¸¸     ---ï¼ˆMock ç½‘ç»œå¤±è´¥ï¼‰
  -----------------------------------------------------------------------------------

**4. é›†æˆæµ‹è¯•è§„èŒƒï¼ˆL3ï¼‰**

**4.1 å®Œæ•´åˆ†ææµç¨‹é›†æˆæµ‹è¯•**

é›†æˆæµ‹è¯•ä½¿ç”¨å®Œæ•´çš„ Fixture æ•°æ®é›†ï¼Œæ¨¡æ‹Ÿ L1
æ·±åº¦åˆ†æï¼ˆ1è½®è¾©è®ºï¼ŒæŠ€æœ¯+æ–°é—»åˆ†æå¸ˆï¼‰ï¼ŒMock LLM
è°ƒç”¨ï¼ˆè¿”å›é¢„å®šä¹‰çš„ç»“æ„åŒ–å“åº”ï¼‰ï¼Œç«¯åˆ°ç«¯éªŒè¯æ•´ä¸ª LangGraph å·¥ä½œæµã€‚

  ---------------------------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **æµ‹è¯•å†…å®¹**                     **éªŒè¯é‡ç‚¹**
  ID**                                          
  ------------ -------------------------------- -----------------------------------------------------
  INT-001      AAPL L1 çº§åˆ†æï¼ŒLIVE æ¨¡å¼        TradeDecision ç»“æ„å®Œæ•´ï¼Œdata_sources
                                                éç©ºï¼Œanalysis_date æ­£ç¡®

  INT-002      600519 L1 çº§åˆ†æï¼ŒAKShare æ•°æ®   å¸‚åœºç±»å‹è¯†åˆ«æ­£ç¡®ï¼ŒAè‚¡é€‚é…å™¨è¢«è°ƒç”¨ï¼Œä¸­æ–‡å­—æ®µæ˜ å°„æ­£å¸¸

  INT-003      L2                               DebateQualityReport å­˜åœ¨ï¼Œscore åœ¨ 0-10 èŒƒå›´
               çº§åˆ†æï¼Œè¾©è®ºè£åˆ¤å‘˜èŠ‚ç‚¹æ­£å¸¸è¾“å‡º   

  INT-004      LLM è¾“å‡ºæ ¼å¼é”™è¯¯ï¼ŒPydantic       é‡è¯• 3 æ¬¡å action=INSUFFICIENT_DATAï¼Œé”™è¯¯è®°å½•åˆ°æ—¥å¿—
               é‡è¯•é€»è¾‘                         

  INT-005      Token é¢„ç®—è¶…é™ï¼Œè‡ªåŠ¨é™çº§         é™çº§åˆ° L0ï¼ŒBudgetExceededError è¢«æ­£ç¡®å¤„ç†

  INT-006      æ•°æ®æºä¸»æºå¤±è´¥ï¼ŒFallback åˆ‡æ¢    å¤‡ç”¨æºè¢«è°ƒç”¨ï¼Œdata_quality_report ä¸­ fallbacks_used
                                                éç©º

  INT-007      MongoDB å†™å…¥å®Œæ•´æ€§éªŒè¯           analyses é›†åˆä¸­å­˜åœ¨å®Œæ•´æ–‡æ¡£ï¼Œdecision
                                                å­—æ®µå¯è¢«ååºåˆ—åŒ–ä¸º TradeDecision
  ---------------------------------------------------------------------------------------------------

**4.2 å›å½’æµ‹è¯•å¥—ä»¶ï¼ˆL4ï¼‰------ å‰è§†åå·®å›å½’**

  -------------------------------------------------------------------
  *ä»¥ä¸‹æ˜¯ç³»ç»Ÿæœ€é‡è¦çš„å›å½’æµ‹è¯•ï¼Œåœ¨æ¯æ¬¡ PR
  åˆå¹¶æ—¶å¿…é¡»è¿è¡Œã€‚ä»»ä½•ä¸€ä¸ªç”¨ä¾‹å¤±è´¥å‡è§†ä¸ºä¸¥é‡ç¼ºé™·ï¼Œé˜»æ­¢éƒ¨ç½²ã€‚*

  -------------------------------------------------------------------

  -------------------------------------------------------------------------------------------------------------------------
  **æµ‹è¯•ç”¨ä¾‹   **æµ‹è¯•åç§°**                        **æµ‹è¯•å†…å®¹**                         **é€šè¿‡æ ‡å‡†**
  ID**                                                                                  
  ------------ ----------------------------------- ------------------------------------ -----------------------------------
  REG-001      AAPL å‰è§†åå·®æ¶ˆé™¤éªŒè¯               ä»¥ 2024-01-02 ä¸º analysis_date       å®¡è®¡æ—¥å¿—ä¸­ is_compliant=False
                                                   è¿è¡Œå®Œæ•´åˆ†æï¼Œæ£€æŸ¥æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—   è®°å½•æ•°é‡ä¸º 0

  REG-002      è¿ç»­ 5 æ—¥å†³ç­–å¤šæ ·æ€§                 å¯¹ AAPL è¿è¡Œ 2024-01-02 è‡³           5 ä¸ªå†³ç­–ä¸­è‡³å°‘åŒ…å« 2 ç§ä¸åŒçš„
                                                   2024-01-08 é€æ—¥åˆ†æï¼ˆMock LLMï¼‰      action å€¼ï¼ˆä¸å…¨ä¸º BUYï¼‰

  REG-003      BACKTEST æ¨¡å¼å®æ—¶ API é”å®š          BACKTEST æ¨¡å¼ä¸‹å°è¯•è°ƒç”¨ä»»ä½•å®æ—¶ API  æ‰€æœ‰å®æ—¶è°ƒç”¨æŠ›å‡º
                                                   ç«¯ç‚¹                                 RealtimeAPIBlockedErrorï¼Œæ— ä¸€æ¼ç½‘

  REG-004      å†³ç­–å¯å¤ç°æ€§ï¼ˆç›¸åŒè¾“å…¥â†’ç›¸åŒè¾“å‡ºï¼‰   ç›¸åŒ Fixture æ•°æ®è¿è¡Œä¸¤æ¬¡ L2         ä¸¤æ¬¡è¾“å‡ºçš„ TradeDecision.action å’Œ
                                                   åˆ†æï¼ˆMock LLMï¼Œtemperature=0ï¼‰      confidence å®Œå…¨ç›¸åŒ

  REG-005      æ¸©åº¦å‚æ•°é”å®šéªŒè¯                    æ£€æŸ¥ LLMFactory çš„æ‰€æœ‰ LLM           åœ¨ LIVE å’Œ BACKTEST
                                                   å®ä¾‹åŒ–è°ƒç”¨                           æ¨¡å¼ä¸‹ï¼Œtemperature å‚æ•°å‡ä¸º 0.0
  -------------------------------------------------------------------------------------------------------------------------

**5. Fixture æ•°æ®è§„èŒƒ**

æ‰€æœ‰æµ‹è¯•ä½¿ç”¨æœ¬åœ° Fixture æ•°æ®ï¼Œä¸ä¾èµ–ç½‘ç»œè¯·æ±‚ã€‚Fixture æ–‡ä»¶å­˜æ”¾åœ¨
tests/fixtures/ ç›®å½•ï¼Œç»“æ„å¦‚ä¸‹ï¼š

+-------------------------------------------------------------------+
| tests/                                                            |
|                                                                   |
| â”œâ”€â”€ fixtures/                                                     |
|                                                                   |
| â”‚ â”œâ”€â”€ ohlcv/                                                      |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ aapl_ohlcv_2024_01.csv \# AAPL 2024å¹´1æœˆæ—¥çº¿æ•°æ®          |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ kweichow_ohlcv_2024.csv \# è´µå·èŒ…å°æ—¥çº¿æ•°æ®               |
|                                                                   |
| â”‚ â”‚ â””â”€â”€ tencent_hk_ohlcv.csv \# è…¾è®¯æ¸¯è‚¡æ—¥çº¿æ•°æ®                  |
|                                                                   |
| â”‚ â”œâ”€â”€ fundamentals/                                               |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ aapl_fundamentals.json                                    |
|                                                                   |
| â”‚ â”‚ â””â”€â”€ kweichow_fundamentals.json                                |
|                                                                   |
| â”‚ â”œâ”€â”€ news/                                                       |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ aapl_news_2024_01.json \# å« published_at å­—æ®µ            |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ aapl_news_mixed_dates.json \#                             |
| å«æœªæ¥æ—¥æœŸæ–°é—»ï¼ˆç”¨äºè¿‡æ»¤æµ‹è¯•ï¼‰                                    |
|                                                                   |
| â”‚ â”‚ â””â”€â”€ empty_news.json \# ç©ºæ–°é—»åˆ—è¡¨                             |
|                                                                   |
| â”‚ â”œâ”€â”€ llm_responses/                                              |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ valid_trade_decision.json \# åˆæ³• TradeDecision JSON      |
|                                                                   |
| â”‚ â”‚ â”œâ”€â”€ invalid_format_response.txt \# æ ¼å¼é”™è¯¯å“åº”ï¼ˆæµ‹è¯•é‡è¯•ï¼‰   |
|                                                                   |
| â”‚ â”‚ â””â”€â”€ insufficient_data_response.json                           |
|                                                                   |
| â”‚ â””â”€â”€ README.md \# Fixture è¯´æ˜ä¸ç”Ÿæˆæ–¹æ³•                         |
|                                                                   |
| â”‚                                                                 |
|                                                                   |
| â”œâ”€â”€ unit/                                                         |
|                                                                   |
| â”‚ â”œâ”€â”€ test_temporal_guard.py \# TG-001 \~ TG-012                  |
|                                                                   |
| â”‚ â”œâ”€â”€ test_output_schemas.py \# PM-001 \~ PM-008                  |
|                                                                   |
| â”‚ â”œâ”€â”€ test_market_router.py \# RT-001 \~ RT-008                   |
|                                                                   |
| â”‚ â”œâ”€â”€ test_cache_manager.py                                       |
|                                                                   |
| â”‚ â””â”€â”€ test_cost_estimator.py                                      |
|                                                                   |
| â”‚                                                                 |
|                                                                   |
| â”œâ”€â”€ adapters/                                                     |
|                                                                   |
| â”‚ â”œâ”€â”€ test_yfinance_adapter.py \# YF-001 \~ YF-005                |
|                                                                   |
| â”‚ â””â”€â”€ test_akshare_adapter.py \# AK-001 \~ AK-005                 |
|                                                                   |
| â”‚                                                                 |
|                                                                   |
| â”œâ”€â”€ integration/                                                  |
|                                                                   |
| â”‚ â”œâ”€â”€ test_full_analysis_flow.py \# INT-001 \~ INT-007            |
|                                                                   |
| â”‚ â””â”€â”€ test_backtest_no_lookahead.py \# REG-001 \~ REG-005ï¼ˆå›å½’ï¼‰ |
|                                                                   |
| â”‚                                                                 |
|                                                                   |
| â”œâ”€â”€ conftest.py \# å…±ç”¨ Fixture å’Œ Mock é…ç½®                      |
|                                                                   |
| â””â”€â”€ pytest.ini \# pytest é…ç½®ï¼ˆè¦†ç›–ç‡è¦æ±‚ç­‰ï¼‰                     |
+-------------------------------------------------------------------+

**5.1 conftest.py å…³é”® Fixture å®šä¹‰**

+-------------------------------------------------------------------------+
| \# tests/conftest.py                                                    |
|                                                                         |
| import pytest                                                           |
|                                                                         |
| from datetime import date                                               |
|                                                                         |
| from pstds.temporal.context import TemporalContext                      |
|                                                                         |
| \@pytest.fixture                                                        |
|                                                                         |
| def live_ctx_2024_01_02() -\> TemporalContext:                          |
|                                                                         |
| \"\"\"ç”¨äº AAPL å‰è§†åå·®å›å½’æµ‹è¯•çš„æ ‡å‡†ä¸Šä¸‹æ–‡\"\"\"                      |
|                                                                         |
| return TemporalContext.for_live(date(2024, 1, 2))                       |
|                                                                         |
| \@pytest.fixture                                                        |
|                                                                         |
| def backtest_ctx_2024_01_02() -\> TemporalContext:                      |
|                                                                         |
| return TemporalContext.for_backtest(date(2024, 1, 2))                   |
|                                                                         |
| \@pytest.fixture                                                        |
|                                                                         |
| def mock_llm_valid_decision(mocker):                                    |
|                                                                         |
| \"\"\"Mock LLM è¿”å›åˆæ³• TradeDecision JSON\"\"\"                        |
|                                                                         |
| response =                                                              |
| open(\'tests/fixtures/llm_responses/valid_trade_decision.json\').read() |
|                                                                         |
| mocker.patch(\'pstds.llm.factory.LLMFactory.create\',                   |
| return_value=MockLLM(response))                                         |
|                                                                         |
| \@pytest.fixture                                                        |
|                                                                         |
| def aapl_ohlcv_fixture() -\> pd.DataFrame:                              |
|                                                                         |
| return pd.read_csv(\'tests/fixtures/ohlcv/aapl_ohlcv_2024_01.csv\',     |
| parse_dates=\[\'date\'\])                                               |
+-------------------------------------------------------------------------+
